FROM debian:13.3-slim AS core

ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=1000

RUN if ! id -u ${USERNAME} >/dev/null 2>&1; then \
    groupadd --gid ${USER_GID} ${USERNAME} && \
    useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME}; \
    fi \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    vim \
    && git config --system core.editor vim \
    && install -d -m 0755 /home/${USERNAME}/.cache \
    && install -d -m 0755 /home/${USERNAME}/.vscode-server/data/Machine \
    && touch /home/${USERNAME}/.vscode-server/data/Machine/settings.json \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.cache \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vscode-server \
    && rm -rf /var/lib/apt/lists/*

FROM core AS shell

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    starship \
    zsh \
    zsh-autosuggestions \
    && usermod --shell /usr/bin/zsh ${USERNAME} \
    && git clone --depth=1 https://github.com/ohmyzsh/ohmyzsh.git /home/${USERNAME}/.oh-my-zsh \
    && printf '%s\n' \
    'export ZSH="$HOME/.oh-my-zsh"' \
    'ZSH_THEME="robbyrussell"' \
    'plugins=(git)' \
    'source "$ZSH/oh-my-zsh.sh"' \
    'source /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh' \
    'if [ -f "$HOME/.config/starship.toml" ]; then export STARSHIP_CONFIG="$HOME/.config/starship.toml"; fi' \
    'if command -v starship >/dev/null 2>&1; then eval "$(starship init zsh)"; fi' \
    > /home/${USERNAME}/.zshrc \
    && touch /home/${USERNAME}/.zsh_history \
    && chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.zshrc \
    && chmod 600 /home/${USERNAME}/.zsh_history \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.oh-my-zsh \
    && rm -rf /var/lib/apt/lists/*

FROM shell AS sdk

ENV GOBIN=/usr/local/go-tools/bin
ENV GOTOOLCHAIN=auto
ENV PATH=${GOBIN}:${PATH}

RUN apt-get update \
    && apt-get install -y --no-install-recommends golang-go \
    && install -d -m 0755 /home/${USERNAME}/go \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/go \
    && install -d -m 0755 ${GOBIN} \
    && X_TOOLS_VERSION="v0.31.0" GOPLS_VERSION="v0.21.1" \
    && install_optional_go_tool() { \
    tool="$1"; \
    version="$2"; \
    echo "Installing ${tool}@${version}..."; \
    if ! env GOMAXPROCS=1 go install -v "${tool}@${version}"; then \
    echo "Warning: failed to install ${tool}@${version}"; \
    return 1; \
    fi; \
    return 0; \
    } \
    && { \
    install_optional_go_tool golang.org/x/tools/gopls "${GOPLS_VERSION}" \
    || install_optional_go_tool golang.org/x/tools/gopls latest \
    || echo "Warning: gopls is unavailable in this container build."; \
    } \
    && { \
    install_optional_go_tool golang.org/x/tools/cmd/goimports "${X_TOOLS_VERSION}" \
    || install_optional_go_tool golang.org/x/tools/cmd/goimports latest \
    || echo "Warning: goimports is unavailable in this container build."; \
    } \
    && { \
    install_optional_go_tool github.com/go-delve/delve/cmd/dlv latest \
    || echo "Warning: dlv is unavailable in this container build."; \
    } \
    && { \
    install_optional_go_tool honnef.co/go/tools/cmd/staticcheck latest \
    || echo "Warning: staticcheck is unavailable in this container build."; \
    } \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/workspace
COPY go.mod go.sum ./
RUN go mod download

FROM sdk AS project

RUN apt-get update \
    && apt-get install -y --no-install-recommends restic \
    && rm -rf /var/lib/apt/lists/*

USER ${USERNAME}